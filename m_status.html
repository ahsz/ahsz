<!DOCTYPE html> 
<html> 
<head> 
	<meta charset="UTF-8">  </meta> 
	<title>Munka státusz</title>

	<style media="screen" type="text/css"> 

	textarea { 
		resize: none; 
	} 

	</style>
	<link rel="stylesheet" type="text/css" href="m_status.css">
	<script type="text/javascript" src='https://www.google.com/jsapi?autoload={"modules":[{"name":"visualization","version":"1.1","packages":["corechart"]}]}'></script>
	<script type="text/javascript">
		google.setOnLoadCallback(drawChart);
		// TODO bekért linket a DB-ből ideilleszteni
		var gitUrl = 'https://api.github.com/repos/ahsz/ahsz/';
			
		/**
		 * Git API válaszán keresztül a projekt alapinfóinak lekérdezése
		 */
		function gitRoot(response) {
		  var data = response.data;
		  
		  // Az összes commitról kell részletesebb adat is, amiket a következő
		  // kóddal kérjük le
		  for(i = 0; i < data.length; i++) {
			var script = document.createElement('script');
			script.src = gitUrl + 'commits/' + data[i].sha + '?callback=gitChild';
			document.getElementsByTagName('head')[0].appendChild(script);  
		  }
		}
		
		/**
		 * Git API válaszán keresztül a commitok részleteinek bányászása.
		 *  Kell a módosított sorok száma miatt.
		 */
		 function gitChild(response) {			
			var data = response.data;
			var stats = data.stats;
			var date = new Date(data.commit.committer.date);
			var increased = stats.additions - stats.deletions;
			
			var index = -1;
			for (var i = 0; i < dataTable.getNumberOfRows(); i++) {
				var dateToCheck = date;
				var actualDate = dataTable.getValue(i,0);
				if(dateToCheck.getDate() == actualDate.getDate() 
					&& dateToCheck.getMonth() == actualDate.getMonth()
					&& dateToCheck.getFullYear() == actualDate.getFullYear()){
					index = i;
					break;
				}
			}
			if(index == -1){
				dataTable.addRow([date,increased]);
				dataTable.sort([0,1]);
			}else{
				dataTable.setValue(index, 1, dataTable.getValue(index,1) + increased)
			}
			
			
			drawChart();
			//console.log(dataTable);
		}

		
		var dataTable = new google.visualization.DataTable();
		dataTable.addColumn({ type: 'date', label: 'Dátum' });
		dataTable.addColumn({ type: 'number', label: 'Sorok' });
		
		var script = document.createElement('script');  
		script.src = gitUrl + 'commits?callback=gitRoot';
		document.getElementsByTagName('head')[0].appendChild(script);

		/**
		 * Google calendar chart kirajzoltatás
		 */
		function drawChart() {
			var chart = new google.visualization.ColumnChart(document.getElementById('chart_basic'));

			var options = {
			 title: "Kódsorok számának növekedése",
			 height: 350,
			};

			chart.draw(dataTable, options);
		}

	</script>
	
</head>

<body>



	<div style="margin-left:200">
	<h1>Munka státusz</h1>
	</div>
	<div id="chart_basic" style="width: 1000px; height: 350px;"></div>
	</br>
	</br>
	
	<ol class="tree">
		<li>
			<label for="date_1">2015.04.06.</label> <input type="checkbox" id="date_1" /> 
			<ol>
				<li>
					<label for="commit_1">Commit 1</label> <input type="checkbox" id="commit_1" /> 
					<ol>
						<li class="file"><a>person_name</a></li>
						<li class="file"><a>date</a></li>
						<li class="file"><a>modified_rows</a></li>
					</ol>
				</li>
			</ol>
		</li>

		<li>
			<label for="date_2">2015.04.07.</label> <input type="checkbox" id="date_2" /> 
			<ol>
				<li>
					<label for="commit_2">Commit 2</label> <input type="checkbox" id="commit_2" /> 
					<ol>
						<li class="file"><a>person_name</a></li>
						<li class="file"><a>date</a></li>
						<li class="file"><a>modified_rows</a></li>
					</ol>
				</li>
			</ol>
		</li>
	</ol>
	
	
</body>

</html>
